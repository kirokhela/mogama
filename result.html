<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Result</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 100%;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        h1 { color: #333; margin-bottom: 30px; font-size: 2.2em; font-weight: 700; }
        .data-type {
            font-weight: 600; color: #6c757d; margin-bottom: 15px;
            font-size: 1em; text-transform: uppercase;
            letter-spacing: 1px; padding: 10px 20px;
            background: rgba(108, 117, 125, 0.1);
            border-radius: 25px; display: inline-block;
        }
        .accuracy {
            padding: 4px 12px; border-radius: 15px; font-size: 0.8em;
            font-weight: 600; margin-left: 10px;
        }
        .accuracy-high { background: #d4edda; color: #155724; }
        .accuracy-medium { background: #fff3cd; color: #856404; }
        .accuracy-low { background: #f8d7da; color: #721c24; }
        .qr-data {
            background: #f8f9fa; border: 2px solid #e9ecef;
            border-radius: 12px; padding: 25px; margin: 25px 0;
            word-wrap: break-word; font-size: 1.1em; line-height: 1.6;
            color: #495057; font-family: 'Courier New', monospace;
            white-space: pre-wrap; max-height: 200px; overflow-y: auto;
        }
        .employee-info {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0fff0 100%);
            border: 2px solid #28a745; border-radius: 15px;
            padding: 25px; margin: 25px 0; text-align: left; display: none;
        }
        .employee-info h3 {
            color: #155724; text-align: center;
            font-size: 1.3em; margin-bottom: 20px;
        }
        .info-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .info-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;
        }
        .info-label { font-weight: 600; color: #155724; font-size: 0.9em; margin-bottom: 5px; }
        .info-value { color: #495057; font-size: 1.1em; font-weight: 500; }
        .actions {
            margin-top: 30px; display: flex; gap: 15px;
            justify-content: center; flex-wrap: wrap;
        }
        .btn {
            padding: 14px 28px; border: none; border-radius: 10px;
            font-size: 1em; cursor: pointer; font-weight: 600;
            min-width: 140px; transition: all 0.3s ease;
            display: inline-flex; align-items: center; justify-content: center;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
        .btn-primary { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #545b62); color: white; }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); color: white; }
        .btn-attend { background: linear-gradient(135deg, #17a2b8, #138496); color: white; display: none; }
        .icon { margin-right: 8px; font-size: 1.1em; }
        .alert {
            padding: 15px; margin: 20px 0; border-radius: 8px;
            display: none; font-weight: 500;
        }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        @media (max-width: 768px) {
            .container { margin: 10px; padding: 25px; }
            h1 { font-size: 1.8em; }
            .actions { flex-direction: column; }
            .btn { width: 100%; min-width: unset; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ QR Code Analysis</h1>
        <div class="data-type" id="dataType">
            QR Code Content:
            <span class="accuracy" id="accuracyIndicator"></span>
        </div>
        <div class="qr-data" id="qrData">Loading...</div>
        <div class="employee-info" id="employeeInfo">
            <h3>üë§ Employee Information</h3>
            <div class="info-grid" id="infoGrid"></div>
        </div>
        <div class="alert" id="alertBox"></div>
        <div class="actions">
            <button class="btn btn-primary" onclick="copyToClipboard()">
                <span class="icon">üìã</span>Copy to Clipboard
            </button>
            <button class="btn btn-secondary" onclick="goBack()">
                <span class="icon">üì∑</span>Scan Another
            </button>
            <button class="btn btn-success" onclick="openLink()" id="openLinkBtn" style="display:none;">
                <span class="icon">üîó</span>Open Link
            </button>
            <button class="btn btn-attend" onclick="markAttendance()" id="attendBtn">
                <span class="icon">‚úÖ</span>Mark Attendance
            </button>
            <button class="btn btn-attend" onclick="removeFromAttend()" id="removeBtn">
                <span class="icon">‚ùå</span>Remove Attendance
            </button>
        </div>
    </div>

    <script>
        let qrData = "";
        let employeeData = null;

        function getQRData() {
            const urlParams = new URLSearchParams(window.location.search);
            qrData = urlParams.get("data") || "No data found";
            document.getElementById("qrData").textContent = qrData;
            const result = analyzeQRData(qrData);
            document.getElementById("dataType").innerHTML =
                `${result.type}: <span class="accuracy ${result.accuracyClass}">${result.accuracy}</span>`;
            if (result.isEmployee) {
                parseEmployeeData(qrData);
                showEmployeeInfo();
            } else if (result.isURL) {
                document.getElementById("openLinkBtn").style.display = "inline-flex";
            }
        }

        function analyzeQRData(data) {
            const clean = data.trim();
            const employeePatterns = [
                /ID:\s*([^,]+),?\s*Name:\s*([^,]+),?\s*Payment\s*Amount:\s*([^,]+),?\s*Team:\s*([^,\n]*)/i,
                /Employee\s*ID:\s*([^,]+),?\s*Name:\s*([^,]+),?\s*Amount:\s*([^,]+),?\s*Department:\s*([^,\n]*)/i
            ];
            for (let p of employeePatterns) if (p.test(clean)) return { type:"Employee QR Code", accuracy:"High", accuracyClass:"accuracy-high", isEmployee:true, isURL:false };
            try { new URL(clean); return { type:"Website URL", accuracy:"High", accuracyClass:"accuracy-high", isEmployee:false, isURL:true }; } catch {}
            if (/id|name|employee|payment/i.test(clean)) return { type:"Possible Employee Data", accuracy:"Low", accuracyClass:"accuracy-low", isEmployee:true, isURL:false };
            return { type:"Plain Text Content", accuracy:"Medium", accuracyClass:"accuracy-medium", isEmployee:false, isURL:false };
        }

        function parseEmployeeData(data) {
            const patterns = [
                /ID:\s*([^,]+),?\s*Name:\s*([^,]+),?\s*Payment\s*Amount:\s*([^,]+),?\s*Team:\s*([^,\n]*)/i,
                /Employee\s*ID:\s*([^,]+),?\s*Name:\s*([^,]+),?\s*Amount:\s*([^,]+),?\s*Department:\s*([^,\n]*)/i
            ];
            for (let p of patterns) {
                const m = data.match(p);
                if (m) { employeeData = { id:m[1].trim(), name:m[2].trim(), payment:m[3].trim(), team:m[4].trim() }; return; }
            }
        }

        function showEmployeeInfo() {
            if (!employeeData) return;
            const fields = [
                { label: "Employee ID", value: employeeData.id, icon: "üÜî" },
                { label: "Full Name", value: employeeData.name, icon: "üë§" },
                { label: "Payment Amount", value: employeeData.payment, icon: "üí∞" },
                { label: "Team/Department", value: employeeData.team, icon: "üè¢" }
            ];
            document.getElementById("infoGrid").innerHTML = fields.map(f => `
                <div class="info-item"><div class="info-label">${f.icon} ${f.label}</div>
                <div class="info-value">${f.value||"Not specified"}</div></div>`).join("");
            document.getElementById("employeeInfo").style.display = "block";
            document.getElementById("attendBtn").style.display = "inline-flex";
        }

        function copyToClipboard() {
            navigator.clipboard.writeText(qrData).then(() => showAlert("QR data copied!", "success"));
        }
        function goBack() { window.history.back() || (window.location.href="scan.php"); }
        function openLink() { if (qrData.startsWith("http")) window.open(qrData, "_blank"); }

        function markAttendance() {
            if (!employeeData) return showAlert("No employee data!", "danger");
            const btn = document.getElementById("attendBtn");
            btn.disabled = true; btn.innerHTML = "<span class='icon'>‚è≥</span>Processing...";
            fetch("attend.php", {
                method:"POST", headers:{ "Content-Type":"application/json" },
                body: JSON.stringify(employeeData)
            })
            .then(r=>r.json()).then(d=>{
                if (d.success) {
                    showAlert(d.message||"Attendance marked!", "success");
                    btn.innerHTML="<span class='icon'>‚úÖ</span>Attended";
                    document.getElementById("removeBtn").style.display = "inline-flex"; // show remove
                } else {
                    btn.disabled=false; btn.innerHTML="<span class='icon'>‚úÖ</span>Mark Attendance";
                    showAlert(d.message||"Failed", "danger");
                }
            }).catch(e=>{
                btn.disabled=false; btn.innerHTML="<span class='icon'>‚úÖ</span>Mark Attendance";
                showAlert("Network error:"+e.message,"danger");
            });
        }

        function removeFromAttend() {
            if (!employeeData) return showAlert("No employee selected!", "danger");
            const btn = document.getElementById("removeBtn");
            btn.disabled = true; btn.innerHTML = "<span class='icon'>‚è≥</span>Removing...";
            fetch("remove_attendance.php", {
                method:"POST", headers:{ "Content-Type":"application/json" },
                body: JSON.stringify({ id: employeeData.id })
            })
            .then(r=>r.json()).then(d=>{
                if (d.success) {
                    showAlert(d.message||"Attendance removed!", "success");
                    btn.style.display="none";
                    const attendBtn=document.getElementById("attendBtn");
                    attendBtn.disabled=false; attendBtn.innerHTML="<span class='icon'>‚úÖ</span>Mark Attendance";
                } else {
                    btn.disabled=false; btn.innerHTML="<span class='icon'>‚ùå</span>Remove Attendance";
                    showAlert(d.message||"Failed", "danger");
                }
            }).catch(e=>{
                btn.disabled=false; btn.innerHTML="<span class='icon'>‚ùå</span>Remove Attendance";
                showAlert("Network error:"+e.message,"danger");
            });
        }

        function showAlert(msg, type) {
            const box=document.getElementById("alertBox");
            box.className=`alert alert-${type}`; box.innerHTML=msg; box.style.display="block";
            setTimeout(()=>box.style.display="none",4000);
        }

        window.addEventListener("load", getQRData);
    </script>
</body>
</html>
